{% extends 'base.html' %}
{% block title %}Home - Maritime English Dashboard{% endblock %}

{% block page_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
{% endblock %}

{% block content %}
<header class="main-header">
    <nav class="navbar navbar-expand-lg container">
        <div class="container-fluid p-0">
            <a class="navbar-brand" href="{{ url_for('main.home') }}">
                <img src="{{ url_for('static', filename='img/logo_website.png') }}" alt="Maritime English Logo" class="logo-img">
                <span class="logo-text d-none d-sm-inline-block ms-2">Maritime English</span>
            </a>
            <button class="navbar-toggler custom-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0 nav-pills-custom">
                    <li class="nav-item"><a class="nav-link active" href="{{ url_for('main.home') }}"><i class="fas fa-home me-1"></i> Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('learning.courses_page') }}"><i class="fas fa-book-open me-1"></i> Courses</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('learning.report') }}"><i class="fas fa-chart-bar me-1"></i> Report</a></li>
                </ul>
                <div class="user-actions d-flex align-items-center">
                    {% if current_user.is_authenticated %}
                        <div class="nav-item me-3 d-none d-lg-block">
                            <a href="#" class="nav-icon-btn" aria-label="Notifications"><i class="fas fa-bell"></i><span class="badge-dot"></span></a>
                        </div>
                        <div class="dropdown">
                            <a class="user-profile-btn dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <div class="avatar-initials"> {{ current_user.username[0] | upper }}</div>
                                <span class="d-none d-md-inline-block ms-2">{{ current_user.username }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end custom-dropdown fade-in" aria-labelledby="userDropdown">
                                <li class="dropdown-header"><strong>Cadet {{ current_user.username }}</strong></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('main.profile') }}"><i class="fas fa-user me-2"></i> My Profile</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                            </ul>
                        </div>
                    {% else %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-primary-custom">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
</header>

<main class="container my-4 dashboard-container">

    <section class="welcome-banner fade-in-up">
        <div class="banner-content">
            <h1 class="greeting-text">
                <span id="greeting-time" data-is-new="{{ 'true' if current_user.stats.total_learning_time_minutes == 0 else 'false' }}">
                    Welcome aboard
                </span>, <br>
                Cadet {{ current_user.username }}!
            </h1>
            <p class="banner-subtitle">
                {% if current_user.stats.total_learning_time_minutes == 0 %}
                    Let's begin your first voyage in Maritime English
                {% elif current_user.stats.current_unit_progress == 0 %}
                    Ready to start {{ current_user.stats.current_unit_name }}? Let's go!
                {% else %}
                    Keep sailing! You're {{ current_user.stats.current_unit_progress }}% through {{ current_user.stats.current_unit_name }}.
                {% endif %}
            </p>
            <a href="{{ url_for('learning.courses_page') }}" class="btn btn-voyage-start pulse-animation">
                <i class="fas fa-compass fa-spin me-2" style="--fa-animation-duration: 3s;"></i>
                Start Voyage
            </a>
        </div>
        <div class="banner-illustration d-none d-md-flex">
            <img src="{{ url_for('static', filename='img/Captain female-2.png') }}" alt="Female Cadet" class="cadet-img cadet-female slide-in-left">
            <img src="{{ url_for('static', filename='img/Captain male-3.png') }}" alt="Male Cadet" class="cadet-img cadet-male slide-in-right">
        </div>
    </section>

    <div class="row g-4 mt-2">

        {% set current_unit = current_user.stats.total_units_completed + 1 %}

        <div class="col-lg-8 fade-in-up delay-1">
            <div class="map-card">
                <div class="card-header-custom">
                    <div>
                        <i class="fas fa-map-marked-alt me-2"></i>
                        Your Voyage Map
                    </div>
                    <span class="badge">Unit {{ current_unit }} Active</span>
                </div>

                <!-- Peta baru dengan data dinamis -->
                <div class="interactive-map" id="voyageMap"> <!-- Tingginya 345px dari CSS Anda -->
                    <!-- Sky Layer -->
                    <div class="sky-layer"></div>

                    <!-- Clouds -->
                    <div class="cloud cloud-1">
                        <svg width="150" height="80" viewBox="0 0 150 80">
                            <ellipse cx="50" cy="50" rx="40" ry="25"/>
                            <ellipse cx="85" cy="45" rx="45" ry="30"/>
                            <ellipse cx="120" cy="50" rx="35" ry="22"/>
                        </svg>
                    </div>
                    <div class="cloud cloud-2">
                        <svg width="120" height="60" viewBox="0 0 120 60">
                            <ellipse cx="35" cy="35" rx="30" ry="20"/>
                            <ellipse cx="65" cy="30" rx="35" ry="25"/>
                            <ellipse cx="95" cy="35" rx="25" ry="18"/>
                        </svg>
                    </div>
                    <div class="cloud cloud-3">
                        <svg width="100" height="50" viewBox="0 0 100 50">
                            <ellipse cx="30" cy="30" rx="25" ry="15"/>
                            <ellipse cx="55" cy="28" rx="30" ry="20"/>
                            <ellipse cx="80" cy="30" rx="20" ry="14"/>
                        </svg>
                    </div>

                    <!-- Birds -->
                    <div class="birds">
                        <svg width="80" height="40" viewBox="0 0 80 40">
                            <path class="bird" d="M10 20 Q15 15 20 20 Q15 18 10 20"/>
                            <path class="bird" d="M30 15 Q35 10 40 15 Q35 13 30 15"/>
                            <path class="bird" d="M50 22 Q55 17 60 22 Q55 20 50 22"/>
                            <path class="bird" d="M25 28 Q30 23 35 28 Q30 26 25 28"/>
                        </svg>
                    </div>

                    <!-- Ocean Waves -->
                    <div class="ocean-layer">
                        <div class="wave wave-1"></div>
                        <div class="wave wave-2"></div>
                    </div>

                    <canvas id="voyageCanvas"></canvas>

                    <!-- Islands (dengan kelas dinamis DAN style bottom baru) -->
                    <!-- DIUBAH: style="... bottom: 15%;" -->
                    <div class="island {% if current_unit == 1 %}active{% elif current_unit > 1 %}completed{% else %}locked{% endif %}" id="unit1" style="left: 2%; bottom: 10%;" data-unit="1" data-title="Spelling the Sea">
                        <svg width="100" height="80" viewBox="0 0 100 80"> <ellipse cx="50" cy="65" rx="45" ry="12" fill="#C9A961"/> <ellipse cx="50" cy="60" rx="40" ry="18" fill="#4A7C59"/> <rect x="48" y="25" width="4" height="35" fill="#8B6914"/> <path d="M50 25 Q35 20 30 30 Q40 28 50 25" fill="#2ECC71"/> <path d="M50 25 Q65 20 70 30 Q60 28 50 25" fill="#27AE60"/> <path d="M50 25 Q50 10 45 15 Q48 20 50 25" fill="#2ECC71"/> <path d="M50 25 Q50 10 55 15 Q52 20 50 25" fill="#27AE60"/> </svg>
                        <div class="lock-badge"><i class="fas {% if current_unit == 1 %}fa-unlock{% elif current_unit > 1 %}fa-check{% else %}fa-lock{% endif %}"></i></div>
                        <div class="island-label">Unit 1</div>
                    </div>

                    <!-- DIUBAH: style="... bottom: 35%;" -->
                    <div class="island {% if current_unit == 2 %}active{% elif current_unit > 2 %}completed{% else %}locked{% endif %}" id="unit2" style="left: 15%; bottom: 35%;" data-unit="2" data-title="Navigation Terms">
                        <svg width="100" height="80" viewBox="0 0 100 80"> <ellipse cx="50" cy="65" rx="45" ry="12" fill="#C9A961"/> <ellipse cx="50" cy="60" rx="40" ry="18" fill="#4A7C59"/> <rect x="48" y="25" width="4" height="35" fill="#8B6914"/> <path d="M50 25 Q35 20 30 30 Q40 28 50 25" fill="#2ECC71"/> <path d="M50 25 Q65 20 70 30 Q60 28 50 25" fill="#27AE60"/> <path d="M50 25 Q50 10 45 15 Q48 20 50 25" fill="#2ECC71"/> <path d="M50 25 Q50 10 55 15 Q52 20 50 25" fill="#27AE60"/> </svg>
                        <div class="lock-badge"><i class="fas {% if current_unit == 2 %}fa-unlock{% elif current_unit > 2 %}fa-check{% else %}fa-lock{% endif %}"></i></div>
                        <div class="island-label">Unit 2</div>
                    </div>

                    <!-- DIUBAH: style="... bottom: 10%;" -->
                    <div class="island {% if current_unit == 3 %}active{% elif current_unit > 3 %}completed{% else %}locked{% endif %}" id="unit3" style="left: 31%; bottom: 10%;" data-unit="3" data-title="Ship Parts">
                        <svg width="100" height="80" viewBox="0 0 100 80"> <ellipse cx="50" cy="65" rx="45" ry="12" fill="#C9A961"/> <ellipse cx="50" cy="60" rx="40" ry="18" fill="#4A7C59"/> <rect x="48" y="25" width="4" height="35" fill="#8B6914"/> <path d="M50 25 Q35 20 30 30 Q40 28 50 25" fill="#2ECC71"/> <path d="M50 25 Q65 20 70 30 Q60 28 50 25" fill="#27AE60"/> <path d="M50 25 Q50 10 45 15 Q48 20 50 25" fill="#2ECC71"/> <path d="M50 25 Q50 10 55 15 Q52 20 50 25" fill="#27AE60"/> </svg>
                        <div class="lock-badge"><i class="fas {% if current_unit == 3 %}fa-unlock{% elif current_unit > 3 %}fa-check{% else %}fa-lock{% endif %}"></i></div>
                        <div class="island-label">Unit 3</div>
                    </div>

                    <!-- DIUBAH: style="... bottom: 35%;" -->
                    <div class="island {% if current_unit == 4 %}active{% elif current_unit > 4 %}completed{% else %}locked{% endif %}" id="unit4" style="left: 46%; bottom: 35%;" data-unit="4" data-title="Maritime Communication">
                        <svg width="100" height="80" viewBox="0 0 100 80"> <ellipse cx="50" cy="65" rx="45" ry="12" fill="#C9A961"/> <ellipse cx="50" cy="60" rx="40" ry="18" fill="#4A7C59"/> <rect x="48" y="25" width="4" height="35" fill="#8B6914"/> <path d="M50 25 Q35 20 30 30 Q40 28 50 25" fill="#2ECC71"/> <path d="M50 25 Q65 20 70 30 Q60 28 50 25" fill="#27AE60"/> <path d="M50 25 Q50 10 45 15 Q48 20 50 25" fill="#2ECC71"/> <path d="M50 25 Q50 10 55 15 Q52 20 50 25" fill="#27AE60"/> </svg>
                        <div class="lock-badge"><i class="fas {% if current_unit == 4 %}fa-unlock{% elif current_unit > 4 %}fa-check{% else %}fa-lock{% endif %}"></i></div>
                        <div class="island-label">Unit 4</div>
                    </div>

                    <!-- DIUBAH: style="... bottom: 10%;" -->
                    <div class="island {% if current_unit == 5 %}active{% elif current_unit > 5 %}completed{% else %}locked{% endif %}" id="unit5" style="left: 63%; bottom: 10%;" data-unit="5" data-title="Emergency Procedures">
                        <svg width="100" height="80" viewBox="0 0 100 80"> <ellipse cx="50" cy="65" rx="45" ry="12" fill="#C9A961"/> <ellipse cx="50" cy="60" rx="40" ry="18" fill="#4A7C59"/> <rect x="48" y="25" width="4" height="35" fill="#8B6914"/> <path d="M50 25 Q35 20 30 30 Q40 28 50 25" fill="#2ECC71"/> <path d="M50 25 Q65 20 70 30 Q60 28 50 25" fill="#27AE60"/> <path d"M50 25 Q50 10 45 15 Q48 20 50 25" fill="#2ECC71"/> <path d="M50 25 Q50 10 55 15 Q52 20 50 25" fill="#27AE60"/> </svg>
                        <div class="lock-badge"><i class="fas {% if current_unit == 5 %}fa-unlock{% elif current_unit > 5 %}fa-check{% else %}fa-lock{% endif %}"></i></div>
                        <div class="island-label">Unit 5</div>
                    </div>

                    <!-- DIUBAH: style="... bottom: 35%;" -->
                    <div class="island {% if current_unit == 6 %}active{% elif current_unit > 6 %}completed{% else %}goal{% endif %}" id="unit6" style="left: 79%; bottom: 35%;" data-unit="6" data-title="Master Certification">
                        <svg width="100" height="80" viewBox="0 0 100 80"> <ellipse cx="50" cy="65" rx="45" ry="12" fill="#C9A961"/> <ellipse cx="50" cy="60" rx="40" ry="18" fill="#4A7C59"/> <rect x="48" y="25" width="4" height="35" fill="#8B6914"/> <path d="M50 25 Q35 20 30 30 Q40 28 50 25" fill="#2ECC71"/> <path d="M50 25 Q65 20 70 30 Q60 28 50 25" fill="#27AE60"/> <path d="M50 25 Q50 10 45 15 Q48 20 50 25" fill="#2ECC71"/> <path d="M50 25 Q50 10 55 15 Q52 20 50 25" fill="#27AE60"/> <rect x="52" y="10" width="2" height="20" fill="#8B6914"/> <polygon points="54,10 70,15 54,20" fill="#E74C3C"/> </svg>
                        <div class="lock-badge"><i class="fas {% if current_unit >= 6 %}fa-flag-checkered{% else %}fa-lock{% endif %}"></i></div>
                        <div class="island-label">Goal ğŸ†</div>
                    </div>
                    
                    <!-- (Sisa kode kapal dan progress... tidak perlu diubah) -->
                    <div class="ship-container" id="userShip" style="left: 2%; bottom: 28%;"> 
                        <div class="ship">
                            <svg viewBox="0 0 120 80" width="100" height="67"> <path d="M10 50 L25 65 L95 65 L110 50 L100 50 L95 55 L25 55 L20 50 Z" fill="#C0392B"/> <path d="M15 45 L20 50 L100 50 L105 45 L95 45 L92 48 L28 48 L25 45 Z" fill="#E74C3C"/> <rect x="30" y="35" width="60" height="13" fill="#ECF0F1"/> <rect x="35" y="38" width="10" height="8" fill="#3498DB"/> <rect x="50" y="38" width="10" height="8" fill="#3498DB"/> <rect x="65" y="38" width="10" height="8" fill="#3498DB"/> <rect x="40" y="20" width="40" height="15" fill="#BDC3C7"/> <rect x="45" y="23" width="12" height="10" fill="#2980B9"/> <rect x="63" y="23" width="12" height="10" fill="#2980B9"/> <rect x="70" y="8" width="8" height="12" fill="#7F8C8D"/> <ellipse cx="74" cy="8" rx="4" ry="2" fill="#95A5A6"/> <circle cx="74" cy="3" r="3" fill="#BDC3C7" opacity="0.7"> <animate attributeName="cy" values="3;-5;3" dur="2s" repeatCount="indefinite"/> <animate attributeName="opacity" values="0.7;0.3;0.7" dur="2s" repeatCount="indefinite"/> </circle> <circle cx="78" cy="0" r="2" fill="#BDC3C7" opacity="0.5"> <animate attributeName="cy" values="0;-8;0" dur="2.5s" repeatCount="indefinite"/> <animate attributeName="opacity" values="0.5;0.2;0.5" dur="2.5s" repeatCount="indefinite"/> </circle> </svg>
                        </div>
                        <div class="ship-wake"></div>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <!-- <div class="progress-indicator">
                        <h4><i class="fas fa-compass"></i> Voyage Progress</h4>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: {{ current_user.stats.current_unit_progress }}%;"></div>
                        </div>
                        <div class="progress-text">
                            Unit {{ current_unit }} of 6 - {{ current_user.stats.current_unit_progress }}% Complete
                        </div>
                    </div> -->

                    <div class="tooltip-custom" id="tooltip"></div>
                </div>
            </div>
        </div>

        <aside class="col-lg-4 d-flex flex-column gap-3 fade-in-up delay-2">
            <div class="stat-card primary-stat">
                <div class="stat-icon"><i class="fas fa-anchor"></i></div>
                <div class="stat-info">
                    <h6>Current Unit</h6>
                    <h3>{{current_user.stats.current_unit_name}}</h3>
                    {% if current_user.stats.current_unit_progress > 0 %}
                        <div class="progress custom-progress mt-2">
                            <div class="progress-bar bg-coral" role="progressbar" style="width: 0%" data-target-width="{{current_user.stats.current_unit_progress}}%" aria-valuenow="{{current_user.stats.current_unit_progress}}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    {% endif %}
                    <small class="text-muted mt-1 d-block">
                        {% if current_user.stats.current_unit_progress == 0 %}
                            Not started yet
                        {% else %}
                            {{current_user.stats.current_unit_progress}}% Complete
                        {% endif %}
                    </small>
                </div>
            </div>
            <div class="stat-card secondary-stat">
                <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                <div class="stat-info">
                    <h6>Total Progress</h6>
                    <h3>{{current_user.stats.total_units_completed}} / 6 Units</h3>
                    <small class="text-muted">Keep sailing!</small>
                </div>
            </div>
             <div class="stat-card tertiary-stat">
                <div class="stat-icon"><i class="fas fa-hourglass-half"></i></div>
                <div class="stat-info">
                    <h6>Learning Time</h6>
                    <h3><span id="learning-minutes">{{current_user.stats.total_learning_time_minutes}}</span> Mins</h3>
                    <!-- 
                      --- PERUBAHAN DI SINI ---
                      Kita sekarang menggunakan data dari 'minutes_today'.
                      Kita juga menambah 'if' agar tidak muncul jika 0.
                    -->
                    {% if current_user.stats.minutes_today and current_user.stats.minutes_today > 0 %}
                        <small class="text-success">
                            <i class="fas fa-arrow-up me-1"></i> 
                            +{{ current_user.stats.minutes_today }}m today
                        </small>
                    {% else %}
                        <!-- Tampilkan pesan 'semangat' jika hari ini belum belajar -->
                        <small class="text-muted">Let's start learning today!</small>
                    {% endif %}
                    <!-- --- AKHIR PERUBAHAN --- -->
                </div>
            </div>
        </aside>

    </div> </main>
{% endblock %}

{% block page_js %}
<script src="{{ url_for('static', filename='js/home.js') }}"></script>
{% endblock %}